---

import { config as payloadConfig } from 'mhr-payload'
import { getPayload, type RequiredDataFromCollectionSlug } from 'payload'

import Layout from '../layouts/Layout.astro'
import { generateMeta } from 'src/utilties/generateMeta'

import { getRedirects } from 'src/utilties/redirects'
console.log(await getRedirects())

// TODO: redirects, live preview

export async function getStaticPaths() {
    const payload = await getPayload({ config: payloadConfig })
    const pages = await payload.find({
        collection: 'pages',
        draft: false,
        limit: 1000,
        overrideAccess: false,
        pagination: false,
        select: {
            slug: true,
        }
    })
    
    const params = pages.docs?.map(({ slug }) => {
        if (slug === 'home')
            return { params: {slug: '' } }
        return { params: { slug } }
    })

    return params
}

let page: RequiredDataFromCollectionSlug<'pages'> | null = null

const queryPageBySlug = async ({ slug }: { slug: string }) => {
    if (page) return page
    const payload = await getPayload({ config: payloadConfig })
    const result = await payload.find({
        collection: 'pages',
        limit: 1,
        pagination: false,
        overrideAccess: false,
        where: {
            slug: {
                equals: slug,
            },
        },
    })

    return result.docs?.[0] || null
}

const slug: string = Astro.params.slug ?? 'home';
const url = '/' + slug

page = await queryPageBySlug({
    slug,
})

const {description, openGraph, title} = await generateMeta({doc: page})

 ---

<Layout description={description} openGraph={openGraph} title={title}>
	hello hi
</Layout>