---
import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content'
import PostsIndexRenderer from '../../components/PostsIndexRenderer.astro';
import { config as payloadConfig } from 'app-payload'
import { getPayload } from 'payload';

export const getStaticPaths = (async () => {
    const pageLimit = 10
    const allPosts = await getCollection('posts')
    const totalDocs = allPosts.length
    const totalPages = Math.ceil(totalDocs / pageLimit)
    const pages: { params: { page: string | undefined }, props: { pageLimit: number }}[] = []

    for (let i = 1; i <= totalPages; i++) {
        pages.push({
            params: { page: `page/${String(i)}` },
            props: { pageLimit }
        })
    }
    pages.push({
            params: { page: undefined },
            props: { pageLimit }
        })
    return pages
}) satisfies GetStaticPaths


const { page: pageSlug } = Astro.params;
const { pageLimit } = Astro.props;

  const sanitizedPageNumber = pageSlug ? Number(pageSlug?.split('/').pop()) : 1;
  const payload = await getPayload({ config: payloadConfig })

  const posts = await payload.find({
    collection: 'posts',
    depth: 2,
    limit: pageLimit,
    overrideAccess: false,
    page: sanitizedPageNumber,
    draft: false,
    select: {
      title: true,
      slug: true,
      categories: true,
      meta: true,
    },
  });
---

<PostsIndexRenderer {posts} {pageLimit} />