---
import type { InferGetStaticParamsType, InferGetStaticPropsType, GetStaticPaths } from 'astro';
import { config as payloadConfig } from 'app-payload';
import { getPayload } from 'payload';
import { getPostsIndexStaticPaths } from '../../data/posts';
import PostsIndexRenderer from '../../components/PostsIndexRenderer.astro';

export const getStaticPaths = getPostsIndexStaticPaths satisfies GetStaticPaths;

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { page: pageSlug } = Astro.params as Params;
const { pageLimit } = Astro.props as Props;

const sanitizedPageNumber = pageSlug ? Number(pageSlug?.split('/').pop()) : 1;

const payload = await getPayload({ config: payloadConfig });

const posts = await payload.find({
  collection: 'posts',
  depth: 1,
  limit: pageLimit,
  overrideAccess: false,
  page: sanitizedPageNumber,
  select: {
    title: true,
    slug: true,
    categories: true,
    meta: true,
  },
});

const title = 'Payload Astro Website Template - Posts';
const description = 'All posts in the Payload Astro template.';
const openGraph = { description, title };
---

<PostsIndexRenderer {posts} {pageLimit} {title} {description} {openGraph} />
