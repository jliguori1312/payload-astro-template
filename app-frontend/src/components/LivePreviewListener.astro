<script>
  import { isDocumentEvent, ready } from '@payloadcms/live-preview';

  const serverURL = import.meta.env.PAYLOAD_PUBLIC_SERVER_URL;

  console.log('Live Preview Listener attached. Server URL:', serverURL);

  // Tell the Payload admin panel that the page is ready to receive messages
  ready({
    serverURL: serverURL,
  });

  const onMessage = (event) => {
    // Log all incoming messages for debugging
    console.log('Received message:', event.data);
    console.log('Message origin:', event.origin);

    const isFromPayload = isDocumentEvent(event, serverURL);

    console.log('Is event from Payload?', isFromPayload);

    // Check if the event is a document event from the Payload admin
    if (isFromPayload) {
      console.log('Event is valid, reloading page...');
      // If it is, refresh the page to get the latest draft content
      window.location.reload();
    }
  };

  // Add the event listener when the component mounts
  window.addEventListener('message', onMessage);

  // Astro doesn't have a built-in unmount hook for this type of script,
  // but for a page refresh strategy, it's not critical to remove the listener.
</script>